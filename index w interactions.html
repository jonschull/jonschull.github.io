<html>
<head>
    <script type="text/javascript"  src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script type="text/javascript"  src="https://cdn.jsdelivr.net/npm/brython@3.9.0/brython.min.js">     </script>
    <script type="text/javascript"  src="https://cdnjs.cloudflare.com/ajax/libs/brython/3.8.8/brython_stdlib.js"></script>

    <style type="text/css">
        #mynetwork {
            width: 100%;
            height: 800px;
        }
        table,td,th{
            border: 1px solid black;
        }
        td{
            width:50%
        }
        body {
            margin: 0;            /* Reset default margin */
        }
        iframe {
            display: block;       /* iframes are inline by default */
            background: #000;
            border: none;         /* Reset default border */
            height: 100vh;        /* Viewport-relative units */
            width: 100vw;
        }
    </style>

</head>
<body onload="brython()">
    <script type="text/python">
    from browser import document,html,aio
    from browser.html import *

    errorBox = DIV(PRE(ID='console'))
    document<=errorBox

    import sys
    class MyOutput:
        def __init__(self):
            self.console = document["console"]

        def write(self, text):
            self.console.html +=  text + '</hr>'

    sys.stdout = MyOutput()
    sys.stderr = MyOutput()

    document <= TABLE(  TR( TH('Text')+ TH('Diagram')) +
                        TR( TD('Text goes here!!!',ID='LEFT') + TR(DIV('goes here', id="mynetwork"))))

    nodes =[dict(id="1.1", label='1'),
            dict(id=2, label='2')]

    edges = [{'from':"1.1", 'to': 2}]


    graphString = """
    ID      1
    LABEL   First item
    URL     testsource.html
    TITLE   This is popup text
            this can be multiple lines
            but don't go crazy
    LINKTO  2 3

    ID      2
    LABEL   Second Item
    URL     URL2
    TITLE   This is popup text
    LINKTO  3

    ID      3
    LABEL   Another Second-level Item
    URL     URL3
    TITLE   This is popup text

    """

    keywords = 'ID LABEL URL TITLE LINKTO'.split()

    def getNodes(graphString=graphString):
        #break records at blank lines (shouldn't this be easier?)
        goodLines = []
        for line in graphString.split('\n'):
            line=line.strip()
            if line.strip():             #keep non-blank lines
                goodLines.append(line)
            else:                        #throw out the other
                goodLines.append('BREAK\n')
        goodLines = '\n'.join(goodLines).split('BREAK\n')                    #make a string
        chunks = [line.strip() for line in goodLines if line.strip()]        #split it at the BREAKs to make a chunk that will become a record


        #break each chunk at keyword to create records
        records = []
        for chunk in chunks:
            for keyword in keywords:
                chunk=chunk.replace('\n'+ keyword,'BREAK'+ keyword)
            lines=chunk.split('BREAK')
            records.append([line.strip() for line in lines if line.strip()])
        records

        # convert records into nodes preserving order
        nodes = []
        for record in records:
            node = dict()
            for line in record:
                key = line.split()[0].lower()
                value = ' '.join(line.split(' ')[1:]).strip()
                node[key] = value
            nodes.append(node)

        return(nodes)

    if 0: #test
        for node in getNodes():
            print(node)

    def getEdges(nodes):
            edges = []#[{'from':'1', 'to':'2'}]
            for node in nodes:
                if 'linkto' in node.keys():
                    links = node['linkto'].split()
                    for link in links:
                        edges.append({'from':node['id'],
                                       'to': link})
            return edges
    nodes = getNodes()
    edges = getEdges(nodes)
    print(nodes)
    print(edges)



    data = {'nodes':nodes, 'edges': edges}

    options = { "physics":{"enabled":True
                          },
                "layout":{  "improvedLayout": True},
                    "edges":{"smooth": True,
                             "arrows":{"to":True}
                             },
                     "nodes":{"shape":"box",
                              "font" :"14px"
                             }
                 };

    from browser import window
    container = document['mynetwork']
    network = window.vis.Network.new(container, data, options)

    def networkClick(params):
        print('networkClick', params.nodes)
        ID=params.nodes[0]
        URL = [node['url'] for node in nodes if node['id'] == ID][0]
        document['LEFT'].html = URL;
        aio.run(showFile(URL))

    async def showFile(src):
        # Text file
        req = await aio.ajax("GET", src)
        document['LEFT'].html = req.data

    network.on("click", networkClick);

    </script>


</body>
</html>
